# T3Time 小波包分解 (WPD) 架构图

## 小波包分解部分详细架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        输入: [B, N, L]                                       │
│                    (Batch, Nodes, Sequence Length)                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    WaveletPacketTransform (小波包分解)                       │
│                    Level = 2, Wavelet = 'db4'                               │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │                               │
                    ▼                               ▼
            ┌───────────────┐              ┌───────────────┐
            │  Level 1      │              │  Level 1      │
            │  低频 cA      │              │  高频 cD      │
            │  [B, N, L/2]  │              │  [B, N, L/2]  │
            └───────────────┘              └───────────────┘
                    │                               │
        ┌───────────┴───────────┐       ┌───────────┴───────────┐
        │                       │       │                       │
        ▼                       ▼       ▼                       ▼
┌───────────────┐      ┌───────────────┐      ┌───────────────┐      ┌───────────────┐
│  Level 2      │      │  Level 2      │      │  Level 2      │      │  Level 2      │
│  cA-cA        │      │  cA-cD        │      │  cD-cA        │      │  cD-cD        │
│  [B, N, L/4]  │      │  [B, N, L/4]  │      │  [B, N, L/4]  │      │  [B, N, L/4]  │
│  频段 0       │      │  频段 1       │      │  频段 2       │      │  频段 3       │
│  (最低频)     │      │  (中低频)     │      │  (中高频)     │      │  (最高频)     │
└───────────────┘      └───────────────┘      └───────────────┘      └───────────────┘
        │                       │                       │                       │
        └───────────┬───────────┴───────────┬───────────┴───────────┘
                    │                       
                    ▼                       
┌─────────────────────────────────────────────────────────────────────────────┐
│              独立投影层 (Independent Projection Layers)                       │
│  每个频段使用独立的 Linear(1 → C) 投影                                        │
└─────────────────────────────────────────────────────────────────────────────┘
        │                       │                       │                       │
        ▼                       ▼                       ▼                       ▼
┌───────────────┐      ┌───────────────┐      ┌───────────────┐      ┌───────────────┐
│  Reshape      │      │  Reshape      │      │  Reshape      │      │  Reshape      │
│  [B*N, L/4, 1]│      │  [B*N, L/4, 1]│      │  [B*N, L/4, 1]│      │  [B*N, L/4, 1]│
│       │       │      │       │       │      │       │       │      │       │       │
│       ▼       │      │       ▼       │      │       ▼       │      │       ▼       │
│  Linear(1→C)  │      │  Linear(1→C)  │      │  Linear(1→C)  │      │  Linear(1→C)  │
│  wp_proj[0]   │      │  wp_proj[1]   │      │  wp_proj[2]   │      │  wp_proj[3]   │
│       │       │      │       │       │      │       │       │      │       │       │
│       ▼       │      │       ▼       │      │       ▼       │      │       ▼       │
│  [B*N, L/4, C]│      │  [B*N, L/4, C]│      │  [B*N, L/4, C]│      │  [B*N, L/4, C]│
└───────────────┘      └───────────────┘      └───────────────┘      └───────────────┘
        │                       │                       │                       │
        │                       │                       │                       │
        │  添加频段位置编码      │                       │                       │
        │  + freq_pos_embed[i]  │                       │                       │
        │                       │                       │                       │
        ▼                       ▼                       ▼                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│          GatedTransformerEncoder (共享编码器)                                │
│          对每个频段独立编码                                                   │
└─────────────────────────────────────────────────────────────────────────────┘
        │                       │                       │                       │
        ▼                       ▼                       ▼                       ▼
┌───────────────┐      ┌───────────────┐      ┌───────────────┐      ┌───────────────┐
│  [B*N, L/4, C]│      │  [B*N, L/4, C]│      │  [B*N, L/4, C]│      │  [B*N, L/4, C]│
│  wp_features[0]│      │  wp_features[1]│      │  wp_features[2]│      │  wp_features[3]│
└───────────────┘      └───────────────┘      └───────────────┘      └───────────────┘
        │                       │                       │                       │
        └───────────┬───────────┴───────────┬───────────┴───────────┘
                    │                       
                    ▼                       
┌─────────────────────────────────────────────────────────────────────────────┐
│         WaveletPacketAttentionPooling (小波包注意力池化)                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  对每个频段:                                                                  │
│    1. Attention Weighting:                                                 │
│       attn_weights = Softmax(MLP(features))                                 │
│    2. Weighted Pooling:                                                     │
│       pooled[i] = Σ(features[i] * attn_weights)                             │
│    3. 应用可学习节点权重:                                                    │
│       pooled[i] = pooled[i] * node_weights[i]                               │
│                                                                              │
│  最终融合:                                                                   │
│    final_pooled = Mean([pooled[0], pooled[1], pooled[2], pooled[3]])        │
│    [B*N, C]                                                                 │
└─────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
            ┌───────────────┐
            │   Reshape     │
            │  [B, N, C]    │
            └───────────────┘
                    │
                    ▼
            ┌───────────────┐
            │ wp_features   │
            │  [B, N, C]    │
            └───────────────┘
```

## 关键组件说明

### 1. WaveletPacketTransform (小波包分解)
- **功能**: 递归分解时序信号到多个频段
- **参数**: 
  - `wavelet='db4'`: Daubechies 4 小波基
  - `level=2`: 分解层数，产生 2^level = 4 个频段
- **输出**: 4个频段节点，每个大小为 [B, N, L/4]

### 2. 频段划分 (Level=2 时)
```
原始信号 [B, N, L]
    │
    ├─ Level 1: 低频 cA [B, N, L/2]
    │     │
    │     ├─ Level 2: cA-cA [B, N, L/4] ← 频段 0 (最低频)
    │     └─ Level 2: cA-cD [B, N, L/4] ← 频段 1 (中低频)
    │
    └─ Level 1: 高频 cD [B, N, L/2]
          │
          ├─ Level 2: cD-cA [B, N, L/4] ← 频段 2 (中高频)
          └─ Level 2: cD-cD [B, N, L/4] ← 频段 3 (最高频)
```

### 3. 独立投影层
- 每个频段使用独立的 `Linear(1 → C)` 投影层
- 允许不同频段学习不同的特征表示

### 4. 频段位置编码
- `freq_pos_embed`: [1, num_wp_nodes, C] 可学习参数
- 为每个频段添加特定的位置编码，区分不同频段

### 5. GatedTransformerEncoder
- 共享的编码器，对每个频段独立处理
- 使用门控机制增强特征提取

### 6. WaveletPacketAttentionPooling
- **节点级注意力**: 对每个频段内部进行注意力池化
- **可学习权重**: `node_weights` 学习不同频段的重要性
- **最终融合**: 平均所有频段的池化结果

## 数据流维度变化

```
输入:              [B, N, L]
    ↓ WPD (level=2)
频段节点:          [B, N, L/4] × 4
    ↓ Reshape
    ↓              [B*N, L/4, 1] × 4
    ↓ Linear(1→C)
    ↓              [B*N, L/4, C] × 4
    ↓ + freq_pos_embed
    ↓              [B*N, L/4, C] × 4
    ↓ GatedTransformerEncoder
    ↓              [B*N, L/4, C] × 4
    ↓ AttentionPooling
    ↓              [B*N, C]
    ↓ Reshape
输出:              [B, N, C]
```

## 与整体架构的融合

```
时域分支:          [B, N, L] → [B, N, C] → time_encoded
                                    │
小波包分支:        [B, N, L] → [B, N, C] → wp_features
                                    │
                                    ▼
                         Cross-Attention Fusion
                                    │
                                    ▼
                            fused_features [B, C, N]
```

## 优势特点

1. **精细频段划分**: 比传统小波分解更精细，同时分解低频和高频
2. **独立特征学习**: 每个频段独立投影，学习频段特定特征
3. **自适应权重**: 可学习的节点权重，自动学习频段重要性
4. **注意力池化**: 对每个频段内部进行注意力加权，关注重要时间点
5. **位置编码**: 区分不同频段，增强模型对频段差异的理解
