# 小波包分解的数学公式详解

## 1. 核心数学公式

### 1.1 离散小波变换（DWT）公式

对于输入信号 $x[n]$，长度为 $L$，单步 DWT 分解为：

**低频成分（Approximation, cA）**:
$$cA[k] = \sum_{n} x[n] \cdot h[2k - n]$$

**高频成分（Detail, cD）**:
$$cD[k] = \sum_{n} x[n] \cdot g[2k - n]$$

其中：
- $h[n]$: 低通滤波器系数（Low-pass filter）
- $g[n]$: 高通滤波器系数（High-pass filter）
- $k = 0, 1, 2, ..., \lfloor L/2 \rfloor - 1$: 下采样后的索引
- $2k$: 表示下采样（每2个点取1个）

### 1.2 下采样的数学表示

**下采样操作**:
- 原始索引: $n = 0, 1, 2, ..., L-1$
- 下采样后索引: $k = 0, 1, 2, ..., \lfloor L/2 \rfloor - 1$
- 关系: $k = \lfloor n/2 \rfloor$ 或 $n = 2k$（保留偶数索引）

**在公式中**:
- $h[2k - n]$ 表示卷积核在位置 $2k - n$ 的系数
- $2k$ 确保只计算下采样后的位置

### 1.3 卷积的数学表示

**离散卷积公式**:
$$(x * h)[k] = \sum_{n} x[n] \cdot h[k - n]$$

**在 DWT 中**:
$$cA[k] = \sum_{n} x[n] \cdot h[2k - n] = (x * h)[2k]$$

这等价于：先卷积，再下采样（取偶数索引）。

---

## 2. 小波包分解的递归公式

### 2.1 Level=1 分解

**输入**: 原始信号 $x[n]$, 长度 $L$

**输出**:
$$cA_1[k] = \sum_{n} x[n] \cdot h[2k - n], \quad k = 0, 1, ..., \lfloor L/2 \rfloor - 1$$

$$cD_1[k] = \sum_{n} x[n] \cdot g[2k - n], \quad k = 0, 1, ..., \lfloor L/2 \rfloor - 1$$

**长度**: 每个输出长度约为 $L/2$

### 2.2 Level=2 分解

**对 $cA_1$ 分解**:
$$cA_1\text{-}cA_2[k] = \sum_{m} cA_1[m] \cdot h[2k - m], \quad k = 0, 1, ..., \lfloor L/4 \rfloor - 1$$

$$cA_1\text{-}cD_2[k] = \sum_{m} cA_1[m] \cdot g[2k - m], \quad k = 0, 1, ..., \lfloor L/4 \rfloor - 1$$

**对 $cD_1$ 分解**:
$$cD_1\text{-}cA_2[k] = \sum_{m} cD_1[m] \cdot h[2k - m], \quad k = 0, 1, ..., \lfloor L/4 \rfloor - 1$$

$$cD_1\text{-}cD_2[k] = \sum_{m} cD_1[m] \cdot g[2k - m], \quad k = 0, 1, ..., \lfloor L/4 \rfloor - 1$$

**长度**: 每个输出长度约为 $L/4$

### 2.3 递归公式（一般形式）

对于 Level $l$，节点 $i$ 的分解：

$$cA_{l,i}[k] = \sum_{m} node_{l-1,i}[m] \cdot h[2k - m]$$

$$cD_{l,i}[k] = \sum_{m} node_{l-1,i}[m] \cdot g[2k - m]$$

---

## 3. 滤波器与小波基函数的关系

### 3.1 小波基函数的数学定义

小波基函数由**双尺度方程（Two-scale Equation）**定义：

#### 尺度函数（Scaling Function）$\phi(t)$

$$\phi(t) = \sqrt{2} \sum_{k=0}^{N-1} h[k] \cdot \phi(2t - k)$$

其中 $N$ 是滤波器长度（db4 中 $N=4$，但实际有 $2N=8$ 个系数）。

#### 小波函数（Wavelet Function）$\psi(t)$

$$\psi(t) = \sqrt{2} \sum_{k=0}^{N-1} g[k] \cdot \phi(2t - k)$$

### 3.2 关键关系

**滤波器系数 = 基函数的展开系数**

- **低通滤波器 $h[k]$** = 尺度函数 $\phi(t)$ 的**展开系数**
- **高通滤波器 $g[k]$** = 小波函数 $\psi(t)$ 的**展开系数**

### 3.3 QMF 关系（Quadrature Mirror Filter）

高通滤波器系数可以通过低通滤波器系数计算：

$$g[k] = (-1)^k \cdot h[N-1-k]$$

**验证**（对于 db4，$N=4$）:
- $g[0] = (-1)^0 \cdot h[3] = h[3]$
- $g[1] = (-1)^1 \cdot h[2] = -h[2]$
- $g[2] = (-1)^2 \cdot h[1] = h[1]$
- $g[3] = (-1)^3 \cdot h[0] = -h[0]$

---

## 4. db4 滤波器的数学公式

### 4.1 Daubechies 4 的理论公式

对于 db4 小波，低通滤波器的 4 个基本系数：

$$h[0] = \frac{1 + \sqrt{3}}{4\sqrt{2}} \approx 0.2304$$

$$h[1] = \frac{3 + \sqrt{3}}{4\sqrt{2}} \approx 0.7148$$

$$h[2] = \frac{3 - \sqrt{3}}{4\sqrt{2}} \approx 0.6309$$

$$h[3] = \frac{1 - \sqrt{3}}{4\sqrt{2}} \approx -0.0280$$

### 4.2 完整滤波器系数（8个）

实际实现中，db4 使用 8 个系数（$2N = 8$）：

$$h = [h[0], h[1], h[2], h[3], h[4], h[5], h[6], h[7]]$$

其中 $h[4] = -h[3]$, $h[5] = -h[2]$, $h[6] = -h[1]$, $h[7] = -h[0]$

### 4.3 高通滤波器系数

根据 QMF 关系：

$$g[k] = (-1)^k \cdot h[7-k], \quad k = 0, 1, ..., 7$$

**具体计算**:
- $g[0] = (-1)^0 \cdot h[7] = -h[0]$
- $g[1] = (-1)^1 \cdot h[6] = -(-h[1]) = h[1]$
- $g[2] = (-1)^2 \cdot h[5] = -h[2]$
- $g[3] = (-1)^3 \cdot h[4] = -(-h[3]) = h[3]$
- $g[4] = (-1)^4 \cdot h[3] = h[3]$
- $g[5] = (-1)^5 \cdot h[2] = -h[2]$
- $g[6] = (-1)^6 \cdot h[1] = h[1]$
- $g[7] = (-1)^7 \cdot h[0] = -h[0]$

---

## 5. 代码实现的数学对应

### 5.1 单步 DWT 实现

```python
# 代码第57-58行
cA = F.conv1d(x_padded, self.dec_lo, stride=2)
cD = F.conv1d(x_padded, self.dec_hi, stride=2)
```

**数学对应**:

$$cA[k] = \sum_{n} x_{padded}[n] \cdot h[2k - n]$$

$$cD[k] = \sum_{n} x_{padded}[n] \cdot g[2k - n]$$

**说明**:
- `F.conv1d(..., stride=2)` 同时实现卷积和下采样
- `stride=2` 对应公式中的 $2k$（下采样）

### 5.2 边界处理

```python
# 代码第56行
x_padded = F.pad(x, (pad_len, pad_len), mode='circular')
```

**数学对应**: 使用循环填充处理边界，确保卷积在边界处也能正确计算。

---

## 6. 完整计算示例

### 6.1 示例：Level=2 的完整计算

**输入**: $x[n] = [x_0, x_1, x_2, ..., x_{95}]$, 长度 $L=96$

#### Level 1 计算

**低频 $cA_1$**:
$$cA_1[0] = \sum_{n} x[n] \cdot h[0 - n] = x[0]h[0] + x[1]h[-1] + ...$$

由于边界处理，实际计算：
$$cA_1[0] = x_{padded}[0]h[0] + x_{padded}[1]h[-1] + ...$$

**高频 $cD_1$**:
$$cD_1[0] = \sum_{n} x[n] \cdot g[0 - n] = x[0]g[0] + x[1]g[-1] + ...$$

**输出长度**: 约 52（考虑边界处理）

#### Level 2 计算

**对 $cA_1$ 分解**:
$$cA_1\text{-}cA_2[0] = \sum_{m} cA_1[m] \cdot h[0 - m]$$

$$cA_1\text{-}cD_2[0] = \sum_{m} cA_1[m] \cdot g[0 - m]$$

**对 $cD_1$ 分解**:
$$cD_1\text{-}cA_2[0] = \sum_{m} cD_1[m] \cdot h[0 - m]$$

$$cD_1\text{-}cD_2[0] = \sum_{m} cD_1[m] \cdot g[0 - m]$$

**输出长度**: 约 30（考虑边界处理）

---

## 7. 滤波器系数的数学性质

### 7.1 归一化条件

$$\sum_{k} h[k]^2 = 1$$

$$\sum_{k} h[k] = \sqrt{2}$$

### 7.2 正交性条件

$$\sum_{k} h[k] \cdot h[k - 2n] = \delta[n]$$

其中 $\delta[n]$ 是 Kronecker delta（$n=0$ 时为 1，否则为 0）。

### 7.3 消失矩（Vanishing Moments）

db4 具有 4 个消失矩：

$$\int_{-\infty}^{\infty} t^m \psi(t) dt = 0, \quad m = 0, 1, 2, 3$$

这意味着小波函数可以很好地表示平滑信号。

---

## 8. 频域解释

### 8.1 滤波器的频域特性

**低通滤波器 $h[n]$**:
- 频率响应: $H(\omega)$
- 特性: 通过低频，抑制高频
- 截止频率: 约 $\pi/2$（归一化频率）

**高通滤波器 $g[n]$**:
- 频率响应: $G(\omega)$
- 特性: 通过高频，抑制低频
- 截止频率: 约 $\pi/2$（归一化频率）

### 8.2 频段划分

对于 Level=2 的分解：

```
频率范围 [0, π] (归一化)
    │
    ├─ Level 1: cA₁ → [0, π/2]  (低频)
    │     │
    │     ├─ Level 2: cA₁-cA₂ → [0, π/4]      (频段0: 最低频)
    │     └─ Level 2: cA₁-cD₂ → [π/4, π/2]   (频段1: 低中频)
    │
    └─ Level 1: cD₁ → [π/2, π]  (高频)
          │
          ├─ Level 2: cD₁-cA₂ → [π/2, 3π/4]   (频段2: 中高频)
          └─ Level 2: cD₁-cD₂ → [3π/4, π]     (频段3: 最高频)
```

---

## 9. 数学公式总结

### 9.1 核心公式

**单步 DWT**:
$$cA[k] = \sum_{n} x[n] \cdot h[2k - n]$$

$$cD[k] = \sum_{n} x[n] \cdot g[2k - n]$$

**QMF 关系**:
$$g[k] = (-1)^k \cdot h[N-1-k]$$

**双尺度方程**:
$$\phi(t) = \sqrt{2} \sum_{k} h[k] \cdot \phi(2t - k)$$

$$\psi(t) = \sqrt{2} \sum_{k} g[k] \cdot \phi(2t - k)$$

### 9.2 db4 滤波器系数公式

$$h[0] = \frac{1 + \sqrt{3}}{4\sqrt{2}}$$

$$h[1] = \frac{3 + \sqrt{3}}{4\sqrt{2}}$$

$$h[2] = \frac{3 - \sqrt{3}}{4\sqrt{2}}$$

$$h[3] = \frac{1 - \sqrt{3}}{4\sqrt{2}}$$

---

## 10. 关键理解

### 10.1 滤波器系数从哪里来？

1. **数学推导**: 通过小波理论推导出最优的滤波器系数
2. **约束条件**: 满足正交性、归一化、消失矩等条件
3. **固定值**: db4 的系数是固定的，不是可学习的

### 10.2 为什么滤波器系数是固定的？

1. **数学最优性**: 经过数学证明，这些系数是最优的
2. **稳定性**: 固定的系数保证分解的稳定性和可解释性
3. **效率**: 避免学习分解系数，减少参数量

### 10.3 滤波器与基函数的关系链

```
小波基函数 (数学定义)
    ↓ 双尺度方程
滤波器系数 (h[k], g[k])
    ↓ 卷积操作
频域分解 (cA, cD)
    ↓ 递归应用
小波包分解 (多个频段)
```

---

## 参考文献

1. Daubechies, I. (1988). "Orthonormal bases of compactly supported wavelets"
2. Mallat, S. (2009). "A Wavelet Tour of Signal Processing"
3. Strang, G., & Nguyen, T. (1996). "Wavelets and Filter Banks"
